var u={};Object.defineProperty(u,"__esModule",{value:!0});var h="Provided shouldReconnect() returned false. Closing permanently.",f="Provided shouldReconnect() resolved to false. Closing permanently.",a=function(){function n(e,t,o){if(o===void 0&&(o={}),this.url=e,this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this.ondown=null,this.onreopen=null,this.CONNECTING=n.CONNECTING,this.OPEN=n.OPEN,this.CLOSING=n.CLOSING,this.CLOSED=n.CLOSED,this.hasBeenOpened=!1,this.isClosed=!1,this.messageBuffer=[],this.nextRetryTime=0,this.reconnectCount=0,this.lastKnownExtensions="",this.lastKnownProtocol="",this.listeners={},t==null||typeof t=="string"||Array.isArray(t)?this.protocols=t:o=t,this.options=p(o),!this.options.wsConstructor)if(typeof WebSocket<"u")this.options.wsConstructor=WebSocket;else throw new Error("WebSocket not present in global scope and no wsConstructor option was provided.");this.openNewWebSocket()}return Object.defineProperty(n.prototype,"binaryType",{get:function(){return this.binaryTypeInternal||"blob"},set:function(e){this.binaryTypeInternal=e,this.ws&&(this.ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bufferedAmount",{get:function(){var e=this.ws?this.ws.bufferedAmount:0,t=!1;return this.messageBuffer.forEach(function(o){var s=d(o);s!=null?e+=s:t=!0}),t&&this.debugLog("Some buffered data had unknown length. bufferedAmount() return value may be below the correct amount."),e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"extensions",{get:function(){return this.ws?this.ws.extensions:this.lastKnownExtensions},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"protocol",{get:function(){return this.ws?this.ws.protocol:this.lastKnownProtocol},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"readyState",{get:function(){return this.isClosed?n.CLOSED:n.OPEN},enumerable:!0,configurable:!0}),n.prototype.close=function(e,t){this.disposeSocket(e,t),this.shutdown(),this.debugLog("WebSocket permanently closed by client.")},n.prototype.send=function(e){if(this.isClosed)throw new Error("WebSocket is already in CLOSING or CLOSED state.");this.ws&&this.ws.readyState===this.OPEN?this.ws.send(e):this.messageBuffer.push(e)},n.prototype.reconnect=function(){if(this.isClosed)throw new Error("Cannot call reconnect() on socket which is permanently closed.");this.disposeSocket(1e3,"Client requested reconnect."),this.handleClose(void 0)},n.prototype.addEventListener=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},n.prototype.dispatchEvent=function(e){return this.dispatchEventOfType(e.type,e)},n.prototype.removeEventListener=function(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(function(o){return o!==t}))},n.prototype.openNewWebSocket=function(){var e=this;if(!this.isClosed){var t=this.options,o=t.connectTimeout,s=t.wsConstructor;this.debugLog("Opening new WebSocket to "+this.url+".");var r=new s(this.url,this.protocols);r.onclose=function(i){return e.handleClose(i)},r.onerror=function(i){return e.handleError(i)},r.onmessage=function(i){return e.handleMessage(i)},r.onopen=function(i){return e.handleOpen(i)},this.connectTimeoutId=setTimeout(function(){e.clearConnectTimeout(),e.disposeSocket(),e.handleClose(void 0)},o),this.ws=r}},n.prototype.handleOpen=function(e){var t=this;if(!(!this.ws||this.isClosed)){var o=this.options.allClearResetTime;this.debugLog("WebSocket opened."),this.binaryTypeInternal!=null?this.ws.binaryType=this.binaryTypeInternal:this.binaryTypeInternal=this.ws.binaryType,this.clearConnectTimeout(),this.hasBeenOpened?this.dispatchEventOfType("reopen",e):(this.dispatchEventOfType("open",e),this.hasBeenOpened=!0),this.messageBuffer.forEach(function(s){return t.send(s)}),this.messageBuffer=[],this.allClearTimeoutId=setTimeout(function(){t.clearAllClearTimeout(),t.nextRetryTime=0,t.reconnectCount=0;var s=o/1e3|0;t.debugLog("WebSocket remained open for "+s+" seconds. Resetting retry time and count.")},o)}},n.prototype.handleMessage=function(e){this.isClosed||this.dispatchEventOfType("message",e)},n.prototype.handleClose=function(e){var t=this;if(!this.isClosed){var o=this.options,s=o.maxReconnectAttempts,r=o.shouldReconnect;if(this.clearConnectTimeout(),this.clearAllClearTimeout(),this.ws&&(this.lastKnownExtensions=this.ws.extensions,this.lastKnownProtocol=this.ws.protocol,this.disposeSocket()),this.dispatchEventOfType("down",e),this.reconnectCount>=s){this.stopReconnecting(e,this.getTooManyFailedReconnectsMessage());return}var i=!e||r(e);typeof i=="boolean"?this.handleWillReconnect(i,e,h):i.then(function(l){t.isClosed||t.handleWillReconnect(l,e,f)})}},n.prototype.handleError=function(e){this.dispatchEventOfType("error",e),this.debugLog("WebSocket encountered an error.")},n.prototype.handleWillReconnect=function(e,t,o){e?this.reestablishConnection():this.stopReconnecting(t,o)},n.prototype.reestablishConnection=function(){var e=this,t=this.options,o=t.minReconnectDelay,s=t.maxReconnectDelay,r=t.reconnectBackoffFactor;this.reconnectCount++;var i=this.nextRetryTime;this.nextRetryTime=Math.max(o,Math.min(this.nextRetryTime*r,s)),setTimeout(function(){return e.openNewWebSocket()},i);var l=i/1e3|0;this.debugLog("WebSocket was closed. Re-opening in "+l+" seconds.")},n.prototype.stopReconnecting=function(e,t){this.debugLog(t),this.shutdown(),e&&this.dispatchEventOfType("close",e)},n.prototype.shutdown=function(){this.isClosed=!0,this.clearAllTimeouts(),this.messageBuffer=[],this.disposeSocket()},n.prototype.disposeSocket=function(e,t){this.ws&&(this.ws.onerror=c,this.ws.onclose=c,this.ws.onmessage=c,this.ws.onopen=c,this.ws.close(e,t),this.ws=void 0)},n.prototype.clearAllTimeouts=function(){this.clearConnectTimeout(),this.clearAllClearTimeout()},n.prototype.clearConnectTimeout=function(){this.connectTimeoutId!=null&&(clearTimeout(this.connectTimeoutId),this.connectTimeoutId=void 0)},n.prototype.clearAllClearTimeout=function(){this.allClearTimeoutId!=null&&(clearTimeout(this.allClearTimeoutId),this.allClearTimeoutId=void 0)},n.prototype.dispatchEventOfType=function(e,t){var o=this;switch(e){case"close":this.onclose&&this.onclose(t);break;case"error":this.onerror&&this.onerror(t);break;case"message":this.onmessage&&this.onmessage(t);break;case"open":this.onopen&&this.onopen(t);break;case"down":this.ondown&&this.ondown(t);break;case"reopen":this.onreopen&&this.onreopen(t);break}return e in this.listeners&&this.listeners[e].slice().forEach(function(s){return o.callListener(s,t)}),!t||!t.defaultPrevented},n.prototype.callListener=function(e,t){typeof e=="function"?e.call(this,t):e.handleEvent.call(this,t)},n.prototype.debugLog=function(e){this.options.debug&&console.log(e)},n.prototype.getTooManyFailedReconnectsMessage=function(){var e=this.options.maxReconnectAttempts;return"Failed to reconnect after "+e+" "+m("attempt",e)+". Closing permanently."},n.DEFAULT_OPTIONS={allClearResetTime:5e3,connectTimeout:5e3,debug:!1,minReconnectDelay:1e3,maxReconnectDelay:3e4,maxReconnectAttempts:Number.POSITIVE_INFINITY,reconnectBackoffFactor:1.5,shouldReconnect:function(){return!0},wsConstructor:void 0},n.CONNECTING=0,n.OPEN=1,n.CLOSING=2,n.CLOSED=3,n}(),y=u.default=a;function p(n){var e={};return Object.keys(a.DEFAULT_OPTIONS).forEach(function(t){var o=n[t];e[t]=o===void 0?a.DEFAULT_OPTIONS[t]:o}),e}function d(n){return typeof n=="string"?2*n.length:n instanceof ArrayBuffer?n.byteLength:n instanceof Blob?n.size:void 0}function m(n,e){return e===1?n:n+"s"}function c(){}export{y as _};
